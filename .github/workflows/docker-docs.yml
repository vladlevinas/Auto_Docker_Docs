name: Docker CLI importer (3x daily)

permissions:
  contents: write

on:
  schedule:
    # Europe/Vilnius: 09:00, 15:00, 21:00 (UTC=07:00,13:00,19:00)
    - cron: "0 7,13,19 * * *"
  workflow_dispatch: {}

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      GIT_AUTHOR_NAME:  ${{ secrets.COMMIT_AUTHOR_NAME }}
      GIT_AUTHOR_EMAIL: ${{ secrets.COMMIT_AUTHOR_EMAIL }}
      GIT_COMMITTER_NAME:  ${{ secrets.COMMIT_AUTHOR_NAME }}
      GIT_COMMITTER_EMAIL: ${{ secrets.COMMIT_AUTHOR_EMAIL }}
    steps:
      - name: Checkout (with your PAT)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          persist-credentials: true
          fetch-depth: 0

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq perl

      - name: Fetch & publish next Docker CLI article
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          mkdir -p .state articles

          # 1) Получить список файлов один раз и кэшировать
          if [ ! -f .state/files.json ]; then
            curl -sSL \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${GITHUB_TOKEN}" \
              https://api.github.com/repos/docker/cli/contents/docs/reference/commandline \
              | jq '[ .[] | select(.type=="file" and (.name|endswith(".md"))) | {name: .name, download_url: .download_url, path: .path}]' \
              > .state/files.json
          fi

          # 2) Отсортированный список
          if [ ! -f .state/ordered.json ]; then
            jq 'sort_by(.name)' .state/files.json > .state/ordered.json
          fi

          # 3) Выбор следующего файла (циклично)
          idx=$( [ -f .state/idx ] && cat .state/idx || echo 0 )
          total=$(jq 'length' .state/ordered.json)
          [ "$total" -gt 0 ] || { echo "No files to process"; exit 1; }
          sel=$(( idx % total ))

          name=$(jq -r ".[$sel].name" .state/ordered.json)
          dl=$(jq -r ".[$sel].download_url" .state/ordered.json)
          src_path=$(jq -r ".[$sel].path" .state/ordered.json)

          tmpfile="$(mktemp)"
          curl -sSL "$dl" -o "$tmpfile"

          title="${name%.md}"
          today="$(date +%F)"
          safe_title="$(echo "$title" | tr ' ' '_' | tr -cd '[:alnum:]_-.')"
          outpath="articles/${today}-${safe_title}.md"

          {
            echo "---"
            echo "source_repo: docker/cli"
            echo "source_path: ${src_path}"
            echo "original_url: https://github.com/docker/cli/blob/master/${src_path}"
            echo "published_at: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            echo "---"
            echo
          } > "$outpath"

          # убрать дублирующий первый заголовок
          awk 'NR==1 && /^# / {next} {print}' "$tmpfile" >> "$outpath"
          rm -f "$tmpfile"

          # 4) Перестроить авто-индекс в README.md
          mapfile -t files < <(git ls-files 'articles/*.md' 2>/dev/null | sort -r)
          index_tmp="$(mktemp)"
          {
            echo "<!-- AUTO-INDEX:BEGIN -->"
            echo
            echo "## Docker CLI — импортированные статьи"
            echo
            echo "| Дата | Файл |"
            echo "|---|---|"
            for f in "${files[@]}"; do
              bn="$(basename "$f")"
              dt="${bn%%-*}"
              echo "| ${dt} | [${bn}](${f}) |"
            done
            echo
            echo "<!-- AUTO-INDEX:END -->"
          } > "$index_tmp"

          if [ ! -f README.md ]; then
            cat > README.md <<'EOF'
# Docker CLI Notes

#Автопубликация 3 раза в день из официальных Docker CLI docs (раздел `commandline`).
#Источники и лицензия: см. нижний раздел README.

<!-- AUTO-INDEX:BEGIN -->
<!-- AUTO-INDEX:END -->

## Attribution & License
- Source: Docker CLI repository (docs/reference/commandline)
- License: Apache-2.0 (Docker CLI repo). Content includes links back to originals.
EOF
          fi

          perl -0777 -pe '
            BEGIN {
              local $/;
              open my $fh, q{<}, $ENV{INDEX_FILE} or die $!;
              $new = <$fh>;
              close $fh;
            }
            s/<!-- AUTO-INDEX:BEGIN -->.*?<!-- AUTO-INDEX:END -->/$new/s
          ' -- - $INDEX_FILE="$index_tmp" README.md > README.md.new
          mv README.md.new README.md
          rm -f "$index_tmp"

          # 5) Коммит от вашего имени (считаться в активность)
          git config user.name  "${GIT_COMMITTER_NAME}"
          git config user.email "${GIT_COMMITTER_EMAIL}"

          git add "$outpath" README.md .state
          echo $((idx+1)) > .state/idx
          git add .state/idx

          GIT_AUTHOR_NAME="${GIT_AUTHOR_NAME}" \
          GIT_AUTHOR_EMAIL="${GIT_AUTHOR_EMAIL}" \
          GIT_COMMITTER_NAME="${GIT_COMMITTER_NAME}" \
          GIT_COMMITTER_EMAIL="${GIT_COMMITTER_EMAIL}" \
          git commit -m "Add: ${title} (${today}); update index" || echo "Nothing to commit"

      - name: Push to main (counts in activity graph)
        run: git push origin HEAD:main

      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Published: Docker CLI doc → ${{ github.repository }}"
          to: ${{ secrets.TO_EMAIL }}
          from: ${{ secrets.FROM_EMAIL }}
          content_type: text/html
          body: |
            <p>Опубликована новая статья из Docker CLI docs.</p>
            <p>Repo: <a href="https://github.com/${{ github.repository }}">ссылка</a></p>
            <p>См. авто-индекс в README.</p>
